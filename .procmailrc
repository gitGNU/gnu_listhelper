# Procmail rules for listhelper system.
#
# Copyright 2006, 2007, 2008 Bob Proulx <bob@proulx.com>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

PATH=$HOME/bin:/usr/local/bin:/usr/bin:/bin
# Let deliver to /var/mail/mlmgr for now and my cron will remind me to read it.
#DEFAULT=$MAILDIR/Maildir/
COMSAT=no
MAILDIR=$HOME/Mail
ARCHIVE=Lists
LOGFILE=$HOME/log/procmail.logfile
# VERBOSE=on
UMASK=02

INCLUDERC=$HOME/.procmailrc-local

# Honeypots are lists that do not receive valid mail.
:0
* ^X-Original-To: listhelper-honeypot
honeypot/

# Save these because they contain passwords that we can use to
# unsubscribe us from those mailing lists.
:0c
* ^Subject: .* mailing list memberships reminder
othermailman/

# Keep track of who is using listhelper.
:0hwic:track-site.lock
| track-site

# Mail to the moderators.  Process and handle.  SpamAssassin is run
# from this script after unpacking the attached message.

:0w:serialize.lock
* ^X-List-Administrivia: yes
* ^X-BeenThere: .*@(freefriends.org|fsf.org|gplv3.fsf.org|fsfeurope.org|gnu.org|gnupress.org|nongnu.org|playogg.org|redhat.com|texinfo.org|tug.org|email.rutgers.edu)$
* ^Subject: .* post from
| mailman-filter || exit 75

# Non-English versions
# Example:
#   Subject: =?iso-8859-1?q?El_envio_a_GNUGNU_de_ansjohn=5F53=40hotmail=2Ecom?=
#   	=?iso-8859-1?q?_precisa_de_aprobacion?=
:0w:serialize.lock
* ^X-List-Administrivia: yes
* ^X-BeenThere: .*@(freefriends.org|fsf.org|gplv3.fsf.org|fsfeurope.org|gnu.org|gnupress.org|nongnu.org|playogg.org|redhat.com|texinfo.org|tug.org|email.rutgers.edu)$
* ^Subject: .*El[ _]envio[ _]a[ _].*[ _]precisa[ _]de[ _]aprobacion
| mailman-filter || exit 75

# Added and combined with other List-Administrivia patterns.
# Example for the regular expression match:
#   Subject: 1 bug-gnu-utils moderator request(s) waiting
#   Subject: bug-grep subscription notification
#   Subject: tug.org mailing list memberships reminder

:0
* ^X-List-Administrivia: yes
{
  :0
  * 1^0 ^Subject: The results of your email commands
  * 1^0 ^Subject: Auto-discard notification
  * 1^0 ^Subject: Last autoresponse notification for today
  * 1^0 ^Subject: [-a-zA-Z0-9]+ subscription notification
  * 1^0 ^Subject: [-a-zA-Z0-9]+ unsubscribe notification
  # Example spanish The results of your email commands
  # Subject: =?iso-8859-1?q?Resultados_de_los_comandos_enviados_por_correo_el?=
  #  =?iso-8859-1?q?ectronico?=
  * 1^0 ^Subject: .*Notificaci.*n_de_suscripci.*n
  # Subject: =?iso-8859-1?q?Notificaci=F3n_de_desuscripci=F3n_a_Radius-espano?=
  #  =?iso-8859-1?q?l?=
  # Subject: =?iso-8859-1?q?fsfe-de_unsubscribe_notification?=
  * 1^0 ^Subject: .*unsubscribe.notification
  * 1^0 ^Subject: .*Notificaci.*n_de_desuscripci.*n
  * 1^0 ^Subject: .*Resultados_de_los_comandos_enviados_por_correo_el
  # Subject: =?iso-8859-1?q?notification_d=27abonnement_de_lilypond-user-fr?=
  * 1^0 ^Subject: .*notification.d.*abonnement_de_
  # Subject: =?iso-8859-1?q?notification_de_r=E9siliation_de_lilypond-user-fr?=
  * 1^0 ^Subject: .*notification.de.r.*siliation.de
  # Subject: M-Zltima notificaciM-sn de autorespuesta de hoy
  * 1^0 ^Subject: .*tima.notificaci.*de.autorespuesta.de.hoy
  # =?iso-8859-1?q?notifica=E7=E3o_de_inscri=E7=E0o_de_Esteban-users?=
  * 1^0 Subject: .*notifica..o_de_inscri._o_de
  /dev/null

  :0
  * 1^0 ^Subject: [0-9]+ [-a-zA-Z0-9]+ moderator request
  * 1^0 ^Subject: [-a-zA-Z0-9.]+ mailing list memberships reminder
  * 1^0 ^Subject: Bounce action notification
  administrivia/
}

# I think this is a mailman bug that it sends messages to the list owner
# to the list moderators too.  /dev/null these.

:0
* ^Sender: mailman-bounces@
* ^TO_[-a-zA-Z0-9]+-owner@
/dev/null

# Mail to the list.  Probably approved but possibly whitelisted.
# Teach all mail through the list as non-spam.  Be careful that random
# other mail through this account is not taught.  This is needed
# because mailman sends other types of messages to the moderator
# address.

# Keep a running counter for later graphing of data.
:0wic:listcounter.lock
| sh -c 'expr $(<$HOME/Mail/listcounter) + 1 >$HOME/Mail/listcounter'

# Learn mail sent to the list as non-spam.  These are few enough.
:0c
* ^X-BeenThere: [-a-zA-Z0-9]+@
* ^X-BeenThere: .*@(freefriends.org|fsf.org|fsfeurope.org|gnu.org|gnupress.org|nongnu.org|playogg.org|redhat.com|texinfo.org|tug.org|email.rutgers.edu)$
* ^Precedence: (list|bulk|fm-user)
* ^List-Archive:
* ^List-Id:
* ^List-Post:
* ^List-Subscribe:
* ^List-Unsubscribe:
| sah >/dev/null 2>&1

# Keep a moving snapshot of mail that comes through to the lists.
# Chain on the previous rule ('A' flag) and match on the listname.

:0A
* ^X-BeenThere: .*@(freefriends.org|fsf.org|fsfeurope.org|gnu.org|gnupress.org|nongnu.org|playogg.org|redhat.com|texinfo.org|tug.org|email.rutgers.edu)$
* ^X-BeenThere: [-a-zA-Z0-9]+@
* ^X-BeenThere: \/[-a-zA-Z0-9]+
$ARCHIVE/$MATCH/

# There is a lot of miscellaneous mail to the listhelper which is ignored.
:0
* ^Sender: mailman-bounces@
/dev/null
